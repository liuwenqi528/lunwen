<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/xhtml">
<head th:replace="base/base::baseHead">
</head>
<body class="childrenBody">
<div class="layui-elem-quote news_search changeBg">
    <form class="layui-form" id="userSearchForm">
        <div class="layui-inline">
            <select id="conditionType" name="conditionType" class="layui-input">
                <option value="username">用户名</option>
                <option value="phone">电话</option>
                <option value="email">邮箱</option>
                <option value="realname">真实姓名</option>
                <option value="channelName">注册渠道</option>
            </select>
        </div>
        <div class="layui-inline">
            <input name="condition" id="condition" placeholder="关键字" class="layui-input search_input">
        </div>
        <div class="layui-inline">
            <input type="text" name="timeRange" id="begin_success" placeholder="创建用户时间范围"
                   autocomplete="off" class="layui-input">
            <input type="hidden" name="beginTime"/>
            <input type="hidden" name="endTime"/>
        </div>
        <div class="layui-inline">
            <a class="iconfont icon-soushuo layui-btn layui-btn-sm" lay-submit lay-filter="userSearch" id="userSearch">搜索</a>
        </div>
        <div class="layui-inline">
            <button class="iconfont icon-reset layui-btn layui-btn-sm layui-btn-primary" type="reset" id="userReset">
                重置
            </button>
        </div>
    </form>
</div>
<div class="layui-form xy-table">
    <div class="layui-inline">
        <a class="layui-btn layui-btn-sm layui-btn-normal" data-type="userAdd">添加</a>
    </div>
    <div class="layui-inline">
        <a class="layui-btn layui-btn-sm layui-btn-danger" data-type="userRemove">删除</a>
    </div>
    <div class="layui-inline">
        <a class="layui-btn layui-btn-sm" data-type="userFlush">刷新</a>
    </div>
    <table class="layui-hide" id="userDatagrid" lay-filter="userDatagrid"></table>
</div>
</body>
<script type="text/javascript" th:inline="none">
    var userDatagrid,currentPage=1,ServerRows=1;
    layui.use(['layer', 'table', 'form','laydate'], function () {
        var layer = layui.layer, form = layui.form,laydate = layui.laydate,
            table = layui.table, $ = layui.jquery;
        //日期
        laydate.render({
            elem: '#begin_success'
            , type: 'datetime'
            , range: '至'
        });
        //监听提交
        form.on('submit(userSearch)', function (data) {
            parseDatetoSplit(data);
            var param = data.field;
            param[data.field.conditionType] = data.field.condition;
            userDatagrid.reload({
                where: param ,page: {
                    curr: 1 //重新从第 1 页开始
                }
            })
            return false;
        });
        //搜索框的回车搜索事件；
        $('#condition').bind('keypress', function (event) {
            if (event.keyCode == "13") {
                var param = [];
                param[$("#conditionType").val()] = $('#condition').val();
                if ($("#begin_success").val()) {
                    var arr = $("#begin_success").val().split('至');
                    param["beginTime"] = arr[0];
                    param["endTime"] = arr[1];
                }
                userDatagrid.reload({
                    where: param
                })
            }
        });
        $('#userReset').on('click', function () {
            $('#userSearchForm')[0].reset();
            $('#userSearch').click();
        })
        userDatagrid = initTable(table,{
            elem: '#userDatagrid'
            , url: basePath + '/sys/user/doDatagrid?orderBy=id=desc'
            , cols: [[ //表头
                {field: 'id', type: 'checkbox'}
                , {field: 'username', title: '用户名', width: '9%'}
                , {field: 'nickname', title: '昵称', width: '9%'}
                , {field: 'realname', title: '真实姓名', width: '9%'}
                , {field: 'email', title: '邮箱', width: '11%'}
                , {field: 'phone', title: '电话', width: '9%'}
                , {field: 'channelName', title: '注册渠道', width: '10%'}
                , {
                    field: 'status', title: '状态', width: '6%', align: 'center', templet: function (row) {
                        if (row.status == "NORMAL") {
                            return '<span  class="layui-btn layui-btn-sm xy-button-light-green us">正常</span>'
                        } else if (row.status == "DISABLED") {
                            return '<span class="layui-btn layui-btn-danger layui-btn-sm us">禁用</span>'
                        } else if (row.status == "LOCKED") {
                            return '<span class="layui-btn layui-btn-normal layui-btn-sm us">锁定</span>'
                        } else if (row.status == "UNACTIVED") {
                            return '<span class="layui-btn xy-button-orange layui-btn-sm us">未激活</span>'
                        } else {
                            return '<span class="layui-btn layui-btn-disabled layui-btn-sm us">已删除</span>'
                        }
                    }
                }
                , {field: 'gmtCreate', title: '创建时间', width: '10%'}
                , {field: 'loginTime', title: '最后登录日期', width: '10%'}
                , {fixed: 'right', title: '操作',align: 'center', templet:function(row){
                    var btn = `<button class="layui-btn layui-btn-sm iconfont icon-chakan" lay-event="userInfo" title="详情"></button>
                                <button class="layui-btn ${row.status == 'CLOSED' ? 'layui-btn-disabled' : 'layui-btn-normal'} layui-btn-sm iconfont icon-xiugai1" lay-event="userEdit" title="编辑" ${row.status == 'CLOSED' ? 'disabled' : ''}></button>
                                <button class="layui-btn ${row.status == 'CLOSED' ? 'layui-btn-disabled' : 'layui-btn-danger'} layui-btn-sm iconfont icon-shanchu" lay-event="userRemove" title="删除" ${row.status == 'CLOSED' ? 'disabled' : ''}></button>
                                <button class="layui-btn ${(row.admin) || (row.status == 'CLOSED') ?'layui-btn-disabled':'xy-button-light-green'} layui-btn-sm iconfont icon-shezhijiaose" lay-event="setRole" title="设置角色" ${(row.admin) || (row.status == 'CLOSED') ? 'disabled' : ''}></button>`;
                    return btn;
                }}
            ]]
            ,  done: function(res, curr, count){
                //如果是异步请求数据方式，res即为你接口返回的信息。
                ServerRows=res.rows.length;
                currentPage=curr;
            }
        })
        //触发事件
        var user = {
            userAdd: function () {
                openLayer('添加用户', basePath + '/sys/user/toAddPage');
            }, userEdit: function (id) {
                var param = "";
                if (id != undefined) {
                    param = "?id=" + id;
                    openLayer('编辑用户', basePath + '/sys/user/toEditPage' + param);
                }
            }, userRemove: function (id) {
                var ids = [];
                if (id != undefined) {
                    ids.push(id);
                } else {
                    var checkStatus = table.checkStatus('userDatagrid')
                        , data = checkStatus.data;
                    for (var i = 0; i < data.length; i++) {
                        ids.push(data[i].id);
                    }
                }
                if (!ids.length) {
                    layer.alert("至少选择一行数据进行删除", {
                        title: '警告'
                    });
                } else {
                    layer.confirm('是否确认删除?', {
                        btn: ['确认', '取消'] //设置询问框上的按钮显示的文字
                    }, function (index) {//点击保存执行的函数
                        $.ajax({
                            url: basePath + '/sys/user/doRemove',
                            data: {ids: ids.join(",")},
                            dataType: "json",
                            type: "post",
                            success: function (data) {
                                layer.msg(data.retInfo);
                                //如果大于第一页
                                if((currentPage>1) && (ServerRows==ids.length)){
                                    --currentPage;
                                }
                                userDatagrid.reload({
                                    page:{
                                        curr:currentPage
                                    }
                                });
                                layer.close(index);
                            }
                        })
                    });
                }
            }, userFlush: function () {
                userDatagrid.reload();
            }, userInfo: function (id) {
                openLayer('用户详情', basePath + '/sys/user/toInfoPage?id=' + id);
            }, setRole: function (id) {
                //设置角色
                openLayer('设置角色', basePath + '/sys/user/toSetRolePage?id=' + id);
            }
        };
        //上部按钮点击事件
        $('.layui-btn').on('click', function () {
            var type = $(this).data('type');
            user[type] ? user[type].call(this) : '';
        });
        //监听工具条
        table.on('tool(userDatagrid)', function (obj) {
            var data = obj.data;
            user[obj.event] ? user[obj.event].call(this, data.id) : '';
        });

    });

</script>
<!--<script type="text/html" id="userBar">-->
    <!--<a class="layui-btn layui-btn-sm iconfont icon-chakan" lay-event="userInfo" title="详情"></a>-->
    <!--<a class="layui-btn layui-btn-normal layui-btn-sm iconfont icon-xiugai1" lay-event="userEdit" title="编辑"></a>-->
    <!--<a class="layui-btn layui-btn-danger layui-btn-sm iconfont icon-shanchu" lay-event="userRemove" title="删除"></a>-->
    <!--<a class="layui-btn layui-btn-sm iconfont icon-shezhijiaose" lay-event="setRole" title="设置角色"></a>-->
<!--</script>-->
<script type="text/javascript" src=${base_Path}+"/static/js/parseDate.js" th:src="@{/js/parseDate.js}"></script>
<style>
.us{
    cursor: default;
}
</style>
</html>