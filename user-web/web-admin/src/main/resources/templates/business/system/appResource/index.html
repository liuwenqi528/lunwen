<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/xhtml">
<head th:replace="base/base::baseHead">
</head>
<body class="childrenBody">
<style>

</style>
<div class="layui-elem-quote news_search xy-toolbar changeBg">
    <form class="layui-form" id="resourceSearchForm">
        <!--<div class="layui-form">-->
        <div class="layui-inline">
            <select id="appSelect" lay-filter="appSelect" name="appCode" lay-search></select>
        </div>
        <div class="layui-inline">
            <select name="resourceType">
                <option value="">--选择资源类型--</option>
                <option value="MODULE">模块</option>
                <option value="OPERATION">操作</option>
            </select>
        </div>
        <div class="layui-inline">
            <input type="text" name="timeRange" id="appResource_date" placeholder="系统资源创建时间范围"
                   autocomplete="off" class="layui-input">
            <input type="hidden" name="beginTime"/>
            <input type="hidden" name="endTime"/>
        </div>
        <div class="layui-inline">
            <button class="layui-btn layui-btn-sm" lay-submit="" id="resourceSearch" lay-filter="resourceSearch">搜索
            </button>
        </div>
        <div class="layui-inline">
            <button class="layui-btn layui-btn-sm layui-btn-primary" id="resourceReset" type="reset">重置</button>
        </div>
        <!--</div>-->
    </form>
</div>
<div class="resourcesContent">  <!--嵌套一层-->
    <div class="btnsOperation">
        <div class="layui-inline">
            <a class="layui-btn layui-btn-sm layui-btn-normal" data-type="resourceAdd">添加</a>
        </div>
        <div class="layui-inline">
            <a class="layui-btn layui-btn-sm" data-type="resourceFlush">刷新</a>
        </div>
    </div>
    <div class="td" id="appResourceTreegrid">
    </div>
</div>
</body>
<script type="text/javascript" th:inline="javascript">
    $(function () {
        $(window).on('resize', function () {
            $('.td').css({width: '100%', height: $(window).height() - 140, border: '1px solid #F6F6F6'})
        }).resize();
    });
    var resourceTreeGird;
    layui.use(['tree', 'layer', 'table', 'form', 'element', 'laydate'], function () {
        var layer = layui.layer, form = layui.form, element = layui.element, laydate = layui.laydate,
            table = layui.table, $ = layui.jquery;

        //资源treegrid 创建
        resourceTreeGird =function (data) {
            $.ajax({
                url: basePath + "/sys/appResource/doTreegrid",
                dataType: "json",
                data: data || {},
                type: "post",
                success: function (data) {
                    $("#appResourceTreegrid").html('');
                    layui.treeGird({
                        elem: '#appResourceTreegrid', //传入元素选择器
                        nodes: data,
                        layout: [
                            {
                                field: 'text',
                                name: '资源名称',
                                treeNodes: true,
                                headerClass: 'value_col',
                                colClass: 'value_col',
                                style: 'width: 20%'
                            },
                            {
                                field: 'url',
                                name: '访问地址',
                                headerClass: 'value_col',
                                colClass: 'value_col',
                                style: 'width: 15%'
                            },
                            {
                                field: 'icon',
                                name: '资源图标',
                                headerClass: 'value_col',
                                colClass: 'value_col',
                                style: 'width: 8%',
                                render: function (row) {
                                    return getIcon(row);
                                }
                            },
                            {
                                field: 'resourceType',
                                name: '资源类别',
                                headerClass: 'value_col',
                                colClass: 'value_col',
                                style: 'width: 8%',
                                render: function (row) {
                                    return getResourceType(row);
                                }
                            },
                            {
                                field: 'gmtCreate',
                                name: '创建时间',
                                headerClass: 'value_col',
                                colClass: 'value_col',
                                style: 'width: 15%'
                            },
                            {
                                field: 'code',
                                name: '资源代码',
                                headerClass: 'value_col',
                                colClass: 'value_col',
                                style: 'width: 15%'
                            },
                            {
                                field: 'level',
                                name: '层级',
                                headerClass: 'value_col',
                                colClass: 'value_col',
                                style: 'width: 5%'
                            },
                            {
                                name: '操作',
                                headerClass: 'value_col',
                                colClass: 'value_col',
                                style: 'width: 15%',
                                render: function (row) {
                                    return resourceOperator(row);
                                }
                            },
                        ]
                    });
                }
            })
        }

        //日期
        laydate.render({
            elem: '#appResource_date'
            , type: 'datetime'
            , range: '至'
        });
        //监听提交
        form.on('submit(resourceSearch)', function (data) {
            parseDatetoSplit(data);
            resourceTreeGird(data.field);
            return false;
        });
        $.ajax({
            url: basePath + '/sys/appRegister/doComboBox',
            dataType: "json",
            type: "post",
            success: function (data) {
                $(data).each(function () {
                    $('#appSelect').append("<option value='" + $(this)[0].code + "'>" + $(this)[0].name + "</option>")
                })
                form.render();
                $('#resourceSearch').click();
            }
        })
        form.on('select(appSelect)', function (data) {
            $('#resourceSearch').click();
        });
        $('#resourceReset').on('click', function () {
            $('#resourceSearchForm')[0].reset();
            $('#resourceSearch').click();
        })
    })

    //触发事件
    var resource = {
        resourceAdd: function (id) {
            var title = "添加顶级资源";
            var selectText = $('#appSelect').next().find('.layui-this');
            if (selectText.length > 0) {
                var param = "?appCode=" + selectText.eq(0).attr('lay-value');
                if (id != undefined) {
                    param += "&id=" + id;
                    title = "添加子资源"
                }
                openLayer(title, basePath + '/sys/appResource/toAddPage' + param);
            } else {
                layer.alert("请先选择一个系统，然后进行添加资源", {
                    title: '警告'
                });
            }
        }, resourceEdit: function (id) {
            var param = "";
            if (id != undefined) {
                param = "?id=" + id;
                openLayer('编辑系统资源', basePath + '/sys/appResource/toEditPage' + param);
            }
        }, resourceRemove: function (id) {
            layer.confirm('是否确认删除?', {
                btn: ['确认', '取消'] //设置询问框上的按钮显示的文字
            }, function (index) {//点击保存执行的函数
                $.ajax({
                    url: basePath + '/sys/appResource/doRemove',
                    data: {ids: id},
                    dataType: "json",
                    type: "post",
                    success: function (data) {
                        layer.msg(data.retInfo);
                        $('#resourceSearch').click();
                    }
                })
            });
        }, resourceFlush: function () {
            $('#resourceSearch').click();
        }, resourceSearch: function (id) {
            openLayer('系统资源详情', basePath + '/sys/appResource/toInfoPage?id=' + id, []);
        }
    };
    //上部按钮点击事件
    $('.layui-btn').on('click', function () {
        var type = $(this).data('type');
        resource[type] ? resource[type].call(this) : '';
    });

    function resourceFunction(type, index) {
        resource[type] ? resource[type].call(this, index) : '';
        event.stopPropagation();
    }

    function getIcon(row) {
        return `<i class="iconfont ${row.icon}"></i>`;
    }

    function getResourceType(row) {
        if (row.resourceType == 'MODULE') {
            return `<span class="layui-btn layui-btn-sm xy-button-light-green"><span>模块</span></span>`;
        } else if (row.resourceType == 'OPERATION') {
            return `<span class="layui-btn layui-btn-sm xy-button-orange"><span>操作</span></span>`;
        } else {
            return "";
        }
    }

    function resourceOperator(row) {
        var btn = `<button class="iconfont icon-chakan xy-button-sm xy-button xy-button-azury" onclick="resourceFunction('resourceSearch',${row.id})" title="详情"></button>
<button class="iconfont icon-xiugai1 xy-button xy-button-sm xy-button-blue" onclick="resourceFunction('resourceEdit',${row.id})" title="编辑"></button>
<button class="iconfont icon-shanchu xy-button xy-button-sm xy-button-red" onclick="resourceFunction('resourceRemove',${row.id})" title="删除"></button>
<button class="iconfont icon-zengjia xy-button xy-button-sm ${row.resourceType == 'MODULE' ? 'xy-button-light-green' : 'xy-button-disabled'}" onclick="resourceFunction('resourceAdd',${row.id})" ${row.resourceType == 'MODULE' ? '' : 'disabled'} title="添加子资源"></button>`;
        return btn;
    }
</script>
</html>