<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/xhtml">
<head th:replace="base/base::baseHead">
</head>
<body class="childrenBody">
<div class="toolbar layui-elem-quote">
    <form class="layui-form" id="personSearchForm">
        <div class="layui-inline">
            <input type="text" class="layui-input" name="name" id="personName" placeholder="人员名称">
        </div>
        <div class="layui-inline">
            <input id="organization" name="organizationId">
        </div>
        <div class="layui-inline">
            <input id="department" name="departmentId">
        </div>
        <div class="layui-inline">
            <button class="layui-btn layui-btn-sm" lay-submit="" lay-filter="personSearch" id="personSearch">搜索</button>
        </div>
        <div class="layui-inline">
            <button class="layui-btn layui-btn-sm layui-btn-primary" id="personReset" type="reset">重置</button>
        </div>
    </form>
</div>
<div class="layui-form xy-table">
    <!--zyc add-->
    <div class="btnsOperation">
        <div class="layui-inline">
            <a class="layui-btn layui-btn-sm layui-btn-normal" data-type="personAdd">添加</a>
        </div>
        <div class="layui-inline">
            <a class="layui-btn layui-btn-sm layui-btn-danger" data-type="personRemove">删除</a>
        </div>
        <div class="layui-inline">
            <a class="layui-btn layui-btn-sm" data-type="personFlush">刷新</a>
        </div>
    </div>
    <!--zyc add-->
    <table class="layui-hide" id="personDatagrid" lay-filter="personDatagrid"></table>
</div>
</body>
<script type="text/javascript" th:inline="none">
    //currentPage记录当前页码   ServerRows记录当前服务器返回的记录数
    var personDatagrid,currentPage=1,ServerRows=1;
    layui.use(['layer', 'table', 'form'], function () {
        var layer = layui.layer, form = layui.form,laydate = layui.laydate,
            table = layui.table, $ = layui.jquery;

        //监听提交
        form.on('submit(personSearch)', function (data) {
            personDatagrid.reload({
                where: data.field
                ,page: {
                    curr: 1 //重新从第 1 页开始
                }
            })
            return false;
        });
        $("#personReset").on('click', function () {
            $('#personSearchForm')[0].reset();
            $("#organization").combotree("clear")
            $("#department").combotree("clear")
            $('#personSearch').click();
        });
        //搜索框的回车搜索事件；
        $('#personName').bind('keypress', function (event) {
            if (event.keyCode == "13") {
                personDatagrid.reload({
                    where: {"name": $("#personName").val()}
                });
                return false;
            }
        });
        personDatagrid = initTable(table,{
            elem: '#personDatagrid'
            , url: basePath + '/org/person/doDatagrid?orderBy=id=desc'
            , cols: [[ //表头
                {field: 'id', type: 'checkbox'}
                , {field: 'name', title: '人员名称', width: '15%'}
                , {field: 'departmentName', title: '所属部门', width: '15%'}
                , {field: 'organizationName', title: '所属机构', width: '15%'}
                , {field: 'userName', title: '关联账号', width: '15%'}
                , {field: 'gmtCreate', title: '创建日期', width: '15%'}
                , {title: '操作', align: 'center', toolbar: '#personBar'}
            ]]
            ,  done: function(res, curr, count){
                //如果是异步请求数据方式，res即为你接口返回的信息。
                //记录当前页 服务器返回的记录数
                ServerRows=res.rows.length;
                currentPage=curr;
            }
        })
        //触发事件
        var person = {
            personAdd: function () {
                openLayer('添加人员', basePath + '/org/person/toAddPage');
            }, personEdit: function (id) {
                var param = "";
                if (id != undefined) {
                    param = "?id=" + id;
                    openLayer('编辑人员', basePath + '/org/person/toEditPage' + param);
                }
            }, personRemove: function (id) {
                var ids = [];
                if (id != undefined) {
                    ids.push(id);
                } else {
                    var checkStatus = table.checkStatus('personDatagrid')
                        , data = checkStatus.data;
                    for (var i = 0; i < data.length; i++) {
                        ids.push(data[i].id);
                    }
                }
                if (ids.length < 1) {
                    layer.alert("至少选择一行数据进行删除", {
                        title: '警告'
                    });
                } else {
                    layer.confirm('是否确认删除?', {
                        btn: ['确认', '取消'] //设置询问框上的按钮显示的文字
                    }, function (index) {//点击保存执行的函数
                        $.ajax({
                            url: basePath + '/org/person/doRemove',
                            data: {ids: ids.join(",")},
                            dataType: "json",
                            type: "post",
                            success: function (data) {
                                layer.msg(data.retInfo);
                                //如果大于第一页
                                if((currentPage>1) && (ServerRows==ids.length)){
                                        --currentPage;
                                }
                                personDatagrid.reload({
                                    page:{
                                        curr:currentPage
                                    }
                                });
                                layer.close(index);
                            }
                        })
                    });
                }
            }, personFlush: function () {
                personDatagrid.reload();
            }, personInfo: function (id) {
                openLayer('人员详情', basePath + '/org/person/toInfoPage?id=' + id);
            }
        };
        //上部按钮点击事件
        $('.layui-btn').on('click', function () {
            var type = $(this).data('type');
            person[type] ? person[type].call(this) : '';
        });
        //监听工具条
        table.on('tool(personDatagrid)', function (obj) {
            var data = obj.data;
            person[obj.event] ? person[obj.event].call(this, data.id) : '';
        });

    });
    $(function () {
        $("#organization").combotree({
            url: basePath + '/org/organization/doTreegrid',
            width:200,
            prompt: '请选择组织机构',
            onSelect: function (node) {
                $("#department").combotree({
                    url: basePath + '/org/department/doTreegrid',
                    queryParams: {
                        "organizationId": node.id
                    }
                })
            }
        });
        $("#department").combotree({
            url: basePath + '/org/department/doTreegrid',
            width:200,
            prompt: '请选择部门'
        });

    });
</script>
<script type="text/html" id="personBar">
    <a class="layui-btn layui-btn-sm iconfont icon-chakan" lay-event="personInfo" title="详情"></a>
    <a class="layui-btn layui-btn-normal layui-btn-sm iconfont icon-xiugai1" lay-event="personEdit" title="编辑"></a>
    <a class="layui-btn layui-btn-danger layui-btn-sm iconfont icon-shanchu" lay-event="personRemove" title="删除"></a>
</script>
</html>
